# Additional contributor roles from subfield $e
do put_macro("rolesFromSubfieldE")
  if exists("$i.e")
    unless is_array("$i.4")
      move_field("$i.4","$i.@4")
      set_array("$i.4")
      move_field("$i.@4","$i.4.$append")          
    end
    do list(path:"$i.e","var":"$e")
      if any_match("$e","(?i).*dars.*")
        add_field("$i.4.$append","act")
      elsif any_match("$e","(?i).*nach.*")
        add_field("$i.4.$append","aft")
      elsif any_match("$e","(?i).*vorl.*")
        add_field("$i.4.$append","ant")
      elsif any_match("$e","(?i).*(Artist|Künstler).*")
        add_field("$i.4.$append","art")
      elsif any_match("$e","(?i).*Vorw.*")
        add_field("$i.4.$append","aui")
      elsif any_match("$e","(?i).*Drehb.*")
        add_field("$i.4.$append","aus")
      elsif any_match("$e","(?i).*(author|Verfasser).*")
        add_field("$i.4.$append","aut")
      elsif any_match("$e","(?i).*B[ü|ue]hnenbild.*") # was http://purl.org/lobid/lv#StageDesign in old morph
        add_field("$i.4.$append","std")
      elsif any_match("$e","(?i).*choreogr.*")
        add_field("$i.4.$append","chr")
      elsif any_match("$e","(?i).*(mitarb|Beitr|Beitr|Komm\\.).*")
        add_field("$i.4.$append","ctb")
      elsif any_match("$e","(?i).*(Komp).*")
        add_field("$i.4.$append","cmp")
      elsif any_match("$e","(?i).*(Dir|Chorleit).*")
        add_field("$i.4.$append","cnd")
      elsif any_match("$e","(?i).*(Sammler).*")
        add_field("$i.4.$append","col")
      elsif any_match("$e","(?i).*(Kartogra).*")
        add_field("$i.4.$append","col")
      elsif any_match("$e","(?i).*(Tänzer).*")
        add_field("$i.4.$append","dnc")
      elsif any_match("$e","(?i).*Herausgebendes Organ.*")
        add_field("$i.4.$append","isb")
      elsif any_match("$e","(?i).*(hrsg|editor|Herausg).*|^Ed\\.$")
        add_field("$i.4.$append","edt")
      elsif any_match("$e","(?i).*(Stecher).*")
        add_field("$i.4.$append","egr")
      elsif any_match("$e","(?i).*(Widmungsempfänger).*")
        add_field("$i.4.$append","hnr")
      elsif any_match("$e","(?i).*(Ill|Zeichn).*")
        add_field("$i.4.$append","ill")
      elsif any_match("$e","(?i).*(Interviewter).*")
        add_field("$i.4.$append","ive")
      elsif any_match("$e","(?i).*(Interviewer).*")
        add_field("$i.4.$append","ivr")
      elsif any_match("$e","(?i).*(Instr|Cembalo|Fagott|Flöte|Gitarre|guitar|Harfe|harp|Horn|Klarinette|clarinet|Klavier|Piano|Kontrabass|Laute|Oboe|Org|Posaune|Saxophon|Schlagzeug|drums|Tromp|Violoncello|Violine).*")
        add_field("$i.4.$append","itr")
      elsif any_match("$e","(?i).*(Libr).*")
        add_field("$i.4.$append","lbt")
      elsif any_match("$e","(?i).*(Ltg).*")
        add_field("$i.4.$append","ltg")
      elsif any_match("$e","(?i).*(Moderation|moderat).*")
        add_field("$i.4.$append","mod")
      elsif any_match("$e","(?i).*(Musi).*")
        add_field("$i.4.$append","mus")
      elsif any_match("$e","(?i).*(Begr).*")
        add_field("$i.4.$append","org")
      elsif any_match("$e","(?i).*(Otogr).*")
        add_field("$i.4.$append","pht")
      elsif any_match("$e","(?i).*(Interpr).*")
        add_field("$i.4.$append","prf")
      elsif any_match("$e","(?i).*(Prod).*")
        add_field("$i.4.$append","pro")
      elsif any_match("$e","(?i).*(Adressat).*")
        add_field("$i.4.$append","rcp")
      elsif any_match("$e","(?i).*(Adressat).*")
        add_field("$i.4.$append","red")
      elsif any_match("$e","(?i).*(Gesang|Alt|Bariton|Bass|Baß|Counterten|Mezzosopr|Sopr|Ten|Singer).*")
        add_field("$i.4.$append","sng")
      elsif any_match("$e","(?i).*(sprecher).*")
        add_field("$i.4.$append","spk")
      elsif any_match("$e","(?i).*(bers|transla).*")
        add_field("$i.4.$append","trl")
      end
    end
    if is_empty("$i.4")
      remove_field("$i.4")
    end
    uniq("$i.4")
  end
end

# Macro for combinedLabel Event / Meeting

do put_macro("gndEventCombinedLabel")
  set_array("$[field].@combinedLabel")  # check if GND concept has combined variant
  copy_field("$[field].a","$[field].@combinedLabel.$append")
  copy_field("$[field].b","$[field].@combinedLabel.$append")
  join_field("$[field].@combinedLabel", ". ") # This is the difference to gnd person
  set_array("$[field].@combinedDetailsForEvents")
  copy_field("$[field].n","$[field].@combinedDetailsForEvents.$append")  
  copy_field("$[field].g","$[field].@combinedDetailsForEvents.$append")
  copy_field("$[field].d","$[field].@combinedDetailsForEvents.$append")
  copy_field("$[field].c","$[field].@combinedDetailsForEvents.$append")        
  join_field("$[field].@combinedDetailsForEvents"," : ")
  unless is_empty("$[field].@combinedDetailsForEvents.")
    paste("$[field].@combinedLabel", "$[field].@combinedLabel", "~ (", "$[field].@combinedDetailsForEvents", "~)", join_char:"")
  end
end

# Macro for combinedLabel Person

do put_macro("gndPersonCombinedLabel")
    set_array("$[field].@combinedLabel")  # check if GND concept has combined variant
    copy_field("$[field].a","$[field].@combinedLabel.$append")
    copy_field("$[field].b","$[field].@combinedLabel.$append")
    join_field("$[field].@combinedLabel", " ") # This is the difference to gnd non person
    if exists("$[field].c")
      paste("$[field].@combinedLabel", "$[field].@combinedLabel", "~, ", "$[field].c", join_char:"")
    end
    if exists("$[field].g")
      paste("$[field].@combinedLabel", "$[field].@combinedLabel", "~ (", "$[field].g", "~)", join_char:"")
    end
    if exists("$[field].x")
      paste("$[field].@combinedLabel", "$[field].@combinedLabel", "~/","$[field].x")
    end
end


# Macro for combinedLabel Non-Person and Non-Event

do put_macro("gndOtherCombinedLabel")
  set_array("$[field].@combinedLabel")  # check if GND concept has combined variant
  copy_field("$[field].a","$[field].@combinedLabel.$append")
  copy_field("$[field].b","$[field].@combinedLabel.$append")
  join_field("$[field].@combinedLabel", ". ") # This is the difference to gnd person
  if exists("$[field].c")
    paste("$[field].@combinedLabel", "$[field].@combinedLabel", "~, ", "$[field].c", join_char:"")
  end
  if exists("$[field].g")
    paste("$[field].@combinedLabel", "$[field].@combinedLabel", "~ (", "$[field].g", "~)", join_char:"")
  end
  if exists("$[field].n")
    paste("$[field].@combinedLabel", "$[field].@combinedLabel", "~, ","$[field].n", join_char:"")
  end
  if exists("$[field].x")
    paste("$[field].@combinedLabel", "$[field].@combinedLabel", "~/","$[field].x")
  end
  if exists("$[field].t")
    paste("$[field].@combinedLabel", "$[field].@combinedLabel", "~: ","$[field].t", join_char:"")
  end
  if exists("$[field].z")
    paste("$[field].@combinedLabel", "$[field].@combinedLabel", "~ (", "$[field].z", "~)", join_char:"")
  end
end

# for describedBy provenance info

do put_macro("provenanceLinks")
  lookup("$[field]","sigel2isilMap")
  replace_all("$[field]", " ", "")
  replace_all("$[field]", "\\/Inst","")
  if any_match("$[field]",".*(hbz|HBZ).*")
    replace_all("$[field]", "^.*$", "DE-605")
  elsif any_match("$[field]","^NRW$|^NRW\\/Hist.Buch$")
    replace_all("$[field]", "^.*$", "DE-605")
  elsif any_match("$[field]","^292$")
    replace_all("$[field]", "^292$", "DE-101b")
  elsif any_match("$[field]","(.*)\\/NWBib$")
    replace_all("describedBy.resultOf.object.sourceOrganization.id", "(.*)\\/NWBib$", "DE-$1")
  elsif any_match("$[field]",".*(dnb|DNB|GWDNB|GWDEB|GWDDB|DEDNM|DEDND).*")
    replace_all("$[field]", "^.*$", "DE-101")
  elsif any_match("$[field]", "^\\d{4}$")
    lookup("$[field]", "picaCreatorId2Isil")
  end
  unless any_match("$[field]","[A-Za-z]{2}-.*")
    prepend("$[field]","DE-")
  end
  prepend("$[field]", "http://lobid.org/organisations/")
  append("$[field]", "#!")
end

# for Schlagwortfolgen

do put_macro("schlagwortfolge")
  if exists("$[field]")
    set_array("subject[].$append.type[]","ComplexSubject")
    set_array("subject[].$last.label")
    set_array("subject[].$last.componentList[]")
    do list(path:"$[field]", "var":"$i")
      set_array("subject[].$last.componentList[].$append.type[]")
      do list(path: "$i.D", "var": "$k")
        copy_field("$k","subject[].$last.componentList[].$last.type[].$append")
      end
      if any_equal("subject[].$last.componentList[].$last.type[]","p")
        call_macro("gndPersonCombinedLabel",field:"$i")
      elsif any_equal("subject[].$last.componentList[].$last.type[]","f")
        call_macro("gndEventCombinedLabel",field:"$i")        
      else
        call_macro("gndOtherCombinedLabel",field:"$i")
      end
      copy_field("$i.@combinedLabel", "subject[].$last.componentList[].$last.label")
      unless any_equal("subject[].$last.componentList[].$last.label","")
        copy_field("subject[].$last.componentList[].$last.label","subject[].$last.label.$append")
      end
      do list(path:"$i.0", "var": "$j")
        if any_match("$j","^\\(DE-588\\)(.*)$")
          add_field("subject[].$last.componentList[].$last.source.label","Gemeinsame Normdatei (GND)")
          add_field("subject[].$last.componentList[].$last.source.id","https://d-nb.info/gnd/7749153-1")
          copy_field("$j", "subject[].$last.componentList[].$last.id")
          replace_all("subject[].$last.componentList[].$last.id","^\\(DE-588\\)(.*)$","https://d-nb.info/gnd/$1")
          copy_field("$j", "subject[].$last.componentList[].$last.gndIdentifier")
          replace_all("subject[].$last.componentList[].$last.gndIdentifier","^\\(DE-588\\)(.*)$","$1")
        end
        # GND idn as variable
        if exists("$i.B")
          do list(path: "$i.B","var":"$gnd")
            unless exists("subject[].$last.componentList[].$last.@gndIdn")
              copy_field("$gnd","subject[].$last.componentList[].$last.@gndIdn")
            end
          end
        elsif any_match("$j","^.*DNB\\|(.*)$")
          copy_field("$j", "subject[].$last.componentList[].$last.@gndIdn")
          replace_all("subject[].$last.componentList[].$last.@gndIdn", "^.*DNB\\|(.*)$","GND-$1")
        elsif any_match("$j","^\\(DE-101\\)(.*)$")
            copy_field("$j", "subject[].$last.componentList[].$last.@gndIdn")
            replace_all("subject[].$last.componentList[].$last.@gndIdn", "^\\(DE-101\\)(.*)$","GND-$1")
        end
      end
      copy_field("$i.d","subject[].$last.componentList[].$last.dateOfBirthAndDeath") # dates will be differentiated later in the process
    end
    join_field("subject[].$last.label"," | ")
  end
end


do put_macro("subjectLabel")
  set_array("subject[].$last.label")
  set_array("$i.@name")
  copy_field("$i.a","$i.@name.$append")
  copy_field("$i.b","$i.@name.$append")
  copy_field("$i.c","$i.@name.$append")
  copy_field("$i.d","$i.@name.$append")
  join_field("$i.@name")
  copy_field("$i.@name","subject[].$last.label.$append")
  copy_field("$i.x","subject[].$last.label.$append")
  copy_field("$i.y","subject[].$last.label.$append")
  copy_field("$i.z","subject[].$last.label.$append")
  copy_field("$i.v","subject[].$last.label.$append")
  join_field("subject[].$last.label"," / ")
end